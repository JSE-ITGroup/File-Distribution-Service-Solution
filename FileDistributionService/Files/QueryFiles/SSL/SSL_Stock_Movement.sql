
		SELECT 
			DISTINCT TOP 100 PERCENT
			 ACCOUNT_REFERENCE AS ACCOUNT,
			 REPLACE(NAME.NAME_TEXT,'???','') as NAME, 
			 ISIN_SHORT_NAME AS SYMBOL,
			cast( BALCHANGE_QTY as decimal(18,0)) AS VOLUME,
			 JNT1.NAME_TEXT as JNT1,
			 JNT2.NAME_TEXT as JNT2,
			 JNT3.NAME_TEXT as JNT3, 
			 CONVERT(varchar(10),BALCHANGE_DATE,120) AS DATE,
			 	(SELECT cast(PHIST_CLOSE as decimal(18,2)) as PHIST_CLOSE
					FROM PRICE_HISTORY WHERE PHIST_ID IN (
						SELECT 
								MAX(PHIST_ID) as PHIST_ID
								FROM 	PRICE_HISTORY
												WHERE 	CAST(PHIST_DATE_START as DATE) <= CAST(ISNULL(BALCHANGE_DATE, GETDATE()) as DATE)
														and CAST(ISNULL(BALCHANGE_DATE, GETDATE()) as DATE) <= CAST(PHIST_DATE_END as DATE)  
														AND PHIST_ISIN=ISIN_ID
						       ))AS PRICE,


			 (SELECT TRANTYPE_DESCRIPTION FROM CONFIG_TRANSACTION_TYPE WHERE TRANTYPE= TRANS_TYPE) AS TRANTYPE_DESCRIPTION ,
			 CASE WHEN BALCHANGE_QTY <  0 THEN (SELECT UPPER(DEPOPART_NAME) FROM DEPOPART WHERE DEPOPART_CODE =TRANS_BROKER) ELSE '' END AS 'FROM_DEALER',
			  CASE WHEN BALCHANGE_QTY >  0 THEN (SELECT UPPER(DEPOPART_NAME) FROM DEPOPART WHERE DEPOPART_CODE =TRANS_BROKER)  ELSE '' END  AS 'TO_DEALER'
			FROM ( 
					 SELECT * FROM TRANS WHERE  TRANS_TYPE IN (N'ITA', N'ITE', N'BD') 
				  )						
				 AS TRANS
				JOIN BALCHANGE ON (BALCHANGE_PARENT = TRANS_ID AND BALCHANGE_TYPE in (0,1,2,9) )
				JOIN ACCOUNT ON (ACCOUNT_ID = BALCHANGE_ACCOUNT)
				LEFT JOIN NAME on ACCOUNT_ID = NAME_ACCOUNT and NAME_SEQUENCE = 1 						
				LEFT JOIN NAME AS JNT1 ON JNT1.NAME_ACCOUNT = ACCOUNT_ID and JNT1.NAME_TYPE = 'O' and JNT1.NAME_SEQUENCE = 2									
				LEFT JOIN NAME AS JNT2 ON JNT2.NAME_ACCOUNT = ACCOUNT_ID and JNT2.NAME_TYPE = 'O' and JNT2.NAME_SEQUENCE = 3									
				LEFT JOIN NAME AS JNT3 ON JNT3.NAME_ACCOUNT = ACCOUNT_ID and JNT3.NAME_TYPE = 'O' and JNT3.NAME_SEQUENCE = 4
				JOIN ISIN ON (ISIN_ID = BALCHANGE_ISIN)
				
			WHERE  
                  TRANS_GROUP in (SELECT DISTINCT TRANS_GROUP FROM TRANS WHERE  TRANS_BROKER='3')							  
 and CONVERT(DATE,BALCHANGE_DATE) = CONVERT(DATE, GETDATE() -20)			   
 ORDER BY  Date desc,
 SYMBOL,
 VOLUME 